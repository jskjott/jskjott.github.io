<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <link rel="stylesheet" href="org-style.css">
  </head>
  <body>
    <div id="buttons">
    </div>
    <div id="subButtons">
    </div>
    <div id="org">
    </div>
  </body>
</html>
<script type="module">
      import init, { parse } from '/process/pkg/org_parser.js'
      import { parseToDomElement } from '/process/parser.js'
      import { addStats } from '/process/stats.js'
      import { addToggleView, addSubButtonEvents } from '/process/eventListeners.js'

      async function run() {
        await init()

        let text
        await fetch('https://raw.githubusercontent.com/jskjott/process.org/master/process.org', {
          headers: new Headers({
            'User-agent': 'Mozilla/4.0 Custom User Agent'
          })
        })
        .then(response => response.text())
        .then(data => {
          text = data
        })
        .catch(error => console.error(error))

        function addButtons(parent, branches) {
          branches.forEach(branch => {
            const button = document.createElement("input")
            button.type = "button"
            button.value = branch
            button.id = branch
            parent.appendChild(button)
          })
        }

        const result = parse(text)

        const topLevelBranches = Object.keys(result.children)
        const buttons = document.querySelector('#buttons')
        addButtons(buttons, topLevelBranches)

        const secondLevelBranches = Object.keys(result.children.Projects.children)
        const subbuttons = document.querySelector('#subbuttons')
        addButtons(subbuttons, secondLevelBranches)

        const dom = parseToDomElement(result.children.Projects, 0)
        dom.className = "tree"

        const parsedBranches = {}
        parsedBranches.Projects = dom

        document.querySelector(`#Projects`).className = 'active'

        const space = document.querySelector('#org')
        space.appendChild(dom)

        if (space.childNodes.length == 2) {
            space.removeChild(space.childNodes[0])
        }

        const elements = document.querySelectorAll("h1, h2, h3, h4, h5, h6")
        addToggleView(elements)

        const subBut = document.querySelector("#subbuttons")
        addSubButtonEvents(subBut.children, parsedBranches, result)

        const h3s = document.querySelectorAll('h3')
        addStats(h3s)

        const but = document.querySelector("#buttons")

        for (let button of but.children) {
          button.addEventListener("click", () => {

            document.querySelector(".active").classList.remove("active")
            button.className = 'active'

            while (subbuttons.firstChild) {
              subbuttons.removeChild(subbuttons.firstChild)
            }
            Object.keys(result.children[button.value].children).forEach(branch => {
              let button = document.createElement("input")
              button.type = "button"
              button.value = branch
              button.id = branch
              subbuttons.appendChild(button)
            })

            const node = document.getElementById("org")
            while (node.firstChild) {
              node.removeChild(node.firstChild)
            }

            if (parsedBranches[button.value]) {
              node.appendChild(parsedBranches[button.value])
            } else {
              const dom = parseToDomElement(result.children[button.value], 0)

              dom.className = "tree"
              parsedBranches[button.value] = dom
              node.appendChild(dom)

              const headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6")
              addToggleView(headers)

              const h3ss = document.querySelectorAll('h3')
              addStats(h3ss)

            }

            const subBut = document.querySelector("#subbuttons")
            addSubButtonEvents(subBut.children, parsedBranches, result)

            button.blur()
          })
        }

      }

      run()
    </script>
