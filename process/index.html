<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <link rel="stylesheet" href="org-style.css">
  </head>
  <body>
    <div id="buttons">
    </div>
    <div id="org">
    </div>
    
  </body>
</html>
<script type="module">
      import init, { parse } from '/process/pkg/org_parser.js'
      import { parseToDomElement } from '/process/parser.js'

      async function run() {
        await init()

        let text

        await fetch('https://raw.githubusercontent.com/jskjott/process.org/master/process.org', {
          headers: new Headers({
            'User-agent': 'Mozilla/4.0 Custom User Agent'
          })
        })
        .then(response => response.text())
        .then(data => {
          text = data
        })
        .catch(error => console.error(error))

        const result = parse(text)

        const buttons = document.querySelector('#buttons')

        let topLevelBranches = Object.keys(result.children)

        topLevelBranches.forEach(branch => {
          let button = document.createElement("input")
          button.type = "button"
          button.value = branch
          buttons.appendChild(button)
        })

        const dom = parseToDomElement(result.children.Projects, 0)
        dom.className = "tree"

        const topBranches = {}
        topBranches.Projects = dom

        const space = document.querySelector('#org')
        space.appendChild(dom)

        if (space.childNodes.length == 2) {
            space.removeChild(space.childNodes[0])
        }

        const elements = document.querySelectorAll("h1, h2, h3, h4, h5, h6")

        elements.forEach(node => {
          const childNodes = node.parentNode.childNodes
          node.addEventListener("click", () => {
            childNodes.forEach((childNode, i) => {
              if (i !== 0) {
                if (childNode.style.display === 'none') {
                  childNode.style.display = 'block'
                } else {
                  childNode.style.display = 'none'
                }
              }
            })
          })
        })

        const but = document.querySelectorAll("input")

        but.forEach(button => {
          button.addEventListener("click", () => {

            const node = document.getElementById("org");
            while (node.firstChild) {
              node.removeChild(node.firstChild);
            }

            if (topBranches[button.value]) {
              node.appendChild(topBranches[button.value])
            } else {
              const dom = parseToDomElement(result.children[button.value], 0)

              dom.className = "tree"

              topBranches[button.value] = dom

              node.appendChild(dom)
            }

          })
        })

      }

      run()
    </script>
